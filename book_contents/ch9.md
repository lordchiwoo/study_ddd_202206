# Chapter 9. 도메인 모델과 바운디드 컨텍스트
## 9.1 도메인 모델과 경계

* 처음 도메인 모델을 만들 때 빠지기 쉬운 함정 : 도메인을 완벽하게 표현하는 단일모델을 만들려는 시도
	> 한 도메인은 여러 하위 도메인으로 구분되기 때문에 
	> 한개의 모델로 여러 하위도메인을 모두 표현하려고 시도하면 
	> 오히려 모든 하위 도메인에 맞지 않는 모델을 만들게 된다.
* 상품이라는 모델
	* 카탈로그에서의 상품 : 상품 이미지/이름/가격/옵션목록/상세설명 같은 상품 정보 위주
	* 재고 관리에서의 상품 : 실존하는 개별객체를 추적하기 위한 목적
* 논리적으로 같은 존재처럼 보이지만 하위 도메인에 따라 다른용어를 사용하기도 한다.
	* ex) 회원 모델의 회원 -> 주문도메인에서는 주문자 -> 배송도메인은 받는 사람
* 따라서 한개의 모델로 모든 하위도메인을 표현하려는 시도는 올바르지 않고 표현도 불가능하다.
* 하위 도메인마다 모델을 만들자.
	* 각 모델은 명시적으로 구분되는 경계를 가져서  섞이지 않도록 해야한다.
	* 여러 하위도메인의 모델이 섞이기 시작하면
		* 모델의 의미도 약해지고 
		* 여러 도메인의 모델이 얽히면서 각 하위도메인 별로 다르게 발전하는 요구사항을 모델에 반영하기 어려워진다.
* 모델은 특정 컨텍스트 하에서 완전한 의미를 가지므로 이렇게 구분되는 경계를 갖는 컨텍스트를 바운디드 컨텍스트라고 한다.
## 9.2 바운디드 컨텍스트
* 바운디드 컨텍스트는 모델의 결계를 결정
* 하나의 바운디드 컨텍스트는 하나의 모델을 갖는다.
* 용어 기준으로 구분하며 실제로 사용자에게 기능을 제공하는 물리적 시스템
	* 도메인 모델은 이 바운디드 컨텍스트 안에서 도메인을 구현
* 이상적으로는 하위도메인과 바운디드 컨텍스트가 1:1관계를 갖는것.
* 현실적으로 기업의 팀 조직구조에 따라 결정되기도 한다.
	* 주문 하위 도메인에 주문을 처리하는 팀/ 복잡한 결제 금액 계산로직을 구현하는 팀
	* 아직 명확하게 구분ㄴ되지 않은 두 하위 도메인을 하나의 바운디드 컨텍스트에서 구현하기도 한다.
	* 규모가 작은 기업은 전체 시스템을 한개 팀에서 구현할때도 있다.
	
* 여러 하위 도메인을 하나의 바운디드 컨텍스트에서 개발할 때 주의할 점
	* 하위 도메인의 모델이 섞이지 않도록 한다.
	* 한 프로젝트에 각 하위 도메인의 모델이 위치하면 전체 하위도메일을 위한 단일모델을 만들고싶은 유혹에 빠질수 있다
		* 도메인 모델이 개별 하위 도메인을 제대로 반영하지 못함
		* 하위 도메인 별로 기능을 확장하기 어렵게 만듬
		* 서비스 경쟁력이 저하되는 결과
	* 한개의 바운디드 컨텍스트가 여러 하위도메인을 포함하더라도 하위 도메인마다 구분되는 패키지를 갖도록 구현
		* 하위 도메인을 위한 모델이 뒤섞이지 않음
		* 하위 도메인마다 바운디드 컨텍스트를 갖는 효과
		
	* 바운디드 컨텍스트는 도메인 모델을 구분하는 경계가 되므로 바운디드 컨텍스트는 구현하는 하위 도메인에 알맞은 모델을 포함
		* 사용자 - 주문 바운디드 컨텍스트 vs 회원 바운디드 컨텍스트
			* 회원의 Member는 애그리거트 루트 / 주문의 orderer는 밸류
		* 상품 - 카탈로그 바운디드 컨텍스트 vs 재고 바운디드 컨텍스트
			* 카탈로그의 Product는 상품의 카테고리와 연관관계 / 재고의 Product는 카테고리와 연관관계를 맺지 않음.
			
		
## 9.3 바운디드 컨텍스트 구현
* 바운디드 컨텍스트는 도메인 기능을 사용자에게 제공하는데 필요한 표현/응용/인프라 영역을 모두 포함한다.
* 도메인 모델의 데이터 구조가 바뀌면 DB테이블 스키마도 변경해야 하므로 테이블도 바운디드 컨텍스트에 포함된다.
* 복잡한 도메인 로직을 갖지 않는 경우
	* 서비스-DAO기능을 사용하면 도메인 기능이 서비스에 흩어지게 되지만 도메인 기능 자체가 단순하므로
	* 굳이 도메인 주도로 개발하지 않고 CRUD방식으로 구현하더라도 기능을 유지보수 하는데 큰 문제가 없다.
* CQRS 패턴
	* 한 바운디드 컨텍스트 안에서 상태를 변경하는 Command와 내용을 조회하는 Query기능을 위한 모델을 구분하는 패턴
	* 상태 변경과 관련된 기능은 도메인 모델기반으로 구현
	* 조회 기능은 서비스-DAO를 이용해서 구현
* 각 바운디드 컨텍스트 별로 서로 다른 구현기술을 사용할 수도 있다.
	* 스프링MVC + JPA/하이버네이트
	* Netty REST API + 마이바티스
	* RDBMS대신 몽고DB 
* 바운디드 컨텍스트에 따라서 사용자에게 보여지는 UI가 아닌 데이터만을 리턴하는 구조를 가질 수도 있다.
	* 혹은 데이터 만을 리턴하고 사용자에게 보여지는 UI는 별도의 UI서버에서 처리하는 방법도 있다.
	


## 9.4 바운디드 컨텍스트 간 통합
* 카탈로그를 위한 바운디드 컨텍스트 + 추천을 위한 바운디드 컨텍스트
	* 상품 추천 기능을 표현하는 도메인 서비스 인터페이스는 도메인 계층에
	* 도메인 모델과 외부시스템간의 모델변환 처리는 인프라 계층에
		* 외부 추천시스템의 API를 이용해서 추천상품 목록을 로딩한다.
		* 해당응답은 카탈로그 도메인 모델과 일치하지 않으므로 카탈로그 도메인 모델과 일치시켜주는 기능을 인프라 계층에 구현하도록 한다.
		* 두 모델간의 변환과정이 복잡하다면 변환처리를 위한 별도 클래스를 만들어 변환을 위임해도 된다.
* 직접 통합하는 API호출 방식 대신 간접통합 방식을 사용할 수도 있다
	* 대표적인 간접통합 : 메시지 큐 사용
		* 카탈로그 바운디드 컨텍스트에서 추천시스템이 필요로 하는 사용자 활동이력을 메시지 큐에 추가(비동기)
		* 추천 바운디드컨텍스트는 큐에서 이력메시지를 읽어와 추천을 계산
			-> 두 바운디드 컨텍스트가 사용할 메시지의 데이터 구조를 맞춰야 한다.
			-> 메시지관리 주체에 따라서 어느 도메인 관점의 데이터를 기준 형식으로 잡을지 바뀔수 있다.
		* 카탈로그 컨텍스트에서 제공하는 경우 출판-구독모델을 따르고
		* 추천 컨텍스트에서 제공할 경우 큐를 통해 메시지를 추천시스템에 전달하는 방식이 된다
			* 비동기라는 점을 제외하면 추천시스템의 REST API를 사용해서 데이터를 전달하는 것과 유사하다.
* 마이크로 서비스의 특징과 바운디드 컨텍스트는 매우 잘 어울린다.

## 9.5 바운디드 컨텍스트 간 관계
* 다양한 방식으로 바운디드 컨텍스트간의 관계를 맺게 된다.
	* 가장 흔한 것이 API 호출 관계
		* 이때 API를 사용하는 바운디드 컨텍스트(하류 컴포넌트)가 API를 제공하는 바운디드 컨텍스트(상류 컴포넌트)에 의존하게 된다.
		* 상류컴포넌트는 공급자/하류컴포넌트는 고객 역할
		* 양쪽 개발팀은 상호협력을 통해 의견을 잘 조율해야한다.
		* 상류 컴포넌트는 프로토콜을 정의해서 공개한다.
			* OHS(공개 호스트 서비스) : 다수의 하류팀이 존재하는 경우 여러 요구사항을 수용하는 API를 만들고 서비스 형태로 공개한다
			* ex) 검색 - 블로그/카페/게시판등의 서비스 제공 포털에서 각 서비스별 검색기능 구현보다는 검색을 위한 전용시스템을 구축한다
		* 상류 컴포넌트는 상류 바운디드컨텍스트의 도메인모델을 따르므로 앞서 언급한 것처럼 변환모듈 등을 통해 하류 컴포넌트는 완충지대를 만들어야 한다(안티 코럽션)
	* 같은 모델을 공유하는 경우 두 팀이 한 모델을 공유함으로써 중복설계를 막을수 있다.(공유 커널)
		* 장점 : 중복이 줄어든다
		* 단점 : 밀접한 관계를 유지하지 못하는 경우 개발이 지연되고 정체되는 문제가 커지게 된다.
	* 마지막으로 독립방식이 있다.
		* 서로 통합하지 않고 독립적으로 모델을 발전시킨다
			* 두 바운디드 컨텍스트간의 통합은 수동으로 이루어진다.
			* 규모가 커질수록 수동통합에 한계가 있으므로 규모가 커지면 결국 통합을 해야함.
				* 이때 외부 바운디드컨텍스트를 대체할수 없다면 별도의 통합시스템을 구축해야 할 수도 있다.

## 9.6 컨텍스트 맵
* 앞서 계속 얘기했듯이 나무만보고 숲을 못보면 안된다.
* 전체 바운디드 컨텍스트 관계를 표시한 컨텍스트 맵을 활용하여 각 바운디드 컨텍스트의 경계를 명확히 드러내고 어떤관계를 맺는지 마악하도록 한다.
	* OHS와 안티코럽션을 기본적으로 표시
	* 하위도메인이나 조직구조를 함께 표시하면 도메인을 포함한 전체 관계를 이해하는데 도움이 된다.
* 전체 구조 파악을 통해 하위도메인과 일치하지 않는 바운디드 컨텍스트를 찾아 도메인에 맞게 조절
* 사업의 핵심도메인을 위해 어떤 바운디드컨텍스트에 조직역량을 집중할지 파악

* 컨텍스트 맵의 규칙은 따로 없고 단순하게 각컨텍스트의 관계를 이해할 수 있도록 그리면 된다.
