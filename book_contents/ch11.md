# Chapter 11. CQRS

## 11.1 단일 모델의 단점
* 조회화면 특성상 조회속도가 빠를 수록 좋은데 여러 애그리거트의 데이터가 필요한 경우 구현방법을 고민해야 한다.
	* 식별자 참조시 즉시로딩같은 JPA쿼리 최적화 기능 사용불가
	* 직접 참조방식일 때도 조회화면 특성에 따라 즉시로딩/지연로딩으로 분리해야 하므로 문제
	* DBMS전용기능이 필요한 경우에도 JPA네이티브쿼리를 사용해야 할 수 있음.
* 이것은 시스템 상태의 변경과 조회에 모두 단일 도메인 모델을 사용하기 때문.
	* ORM기법
		* 도메인 상태변경 기능을 구현하는데는 적합
		* 하지만 여러 애그리거트에서 데이터를 가져와 출력하는 기능을 구현할 때 고려할게 많아져서 구현이 복잡해진다.
* Simple Solution : 상태 변경 모델과 조회 모델의 분리!

## 11.2 CQRS
* 도메인 모델관점에서 상태변경 기능은 주로 한 애그리거트의 상태를 변경한다.
* 반면에 조회기능에 필요한 데이터는 두개 이상의 애그리거트가 필요할 때가 많다.
* 상태 변경 범위와 상태 조회 범위의 불일치 :  단일모델로 두 종류의 기능 구현시 모델이 불필요하게 복잡해진다.
* `CQRS` : Command Query Responsibility Segregation -  상태 변경 "명령"과 상태 제공 "조회" 모델을 분리하는 패턴
	* 복잡한 도메인에 적합 : 복잡할 수록 명령/조회기능의 데이터 범위가 차이남
	* 통계의 경우
		* 단일 도메인 모델을 사용하여 조회시 속도 개선을 위해 JPA관련된 다양한 기능을 모델에 적용해야 한다. 
		* CQRS를 적용해서 조회모델을 별도로 만들면 도메인이 복잡해지는 것을 막을 수 있다.
	* 각 모델에 맞는 구현 기술을 선택하여 구현할수 있다. 
		* `Command`-Domain Model-JPA
		* `Query`-RawSQL-ㅡMyBatis
* 단순히 데이터를 읽어와 조회하는 기능은 응용로직이 복잡하지 않기 때문에 컨트롤러에서 바로 DAO를 실행해도 무방하다.
	* 표현 영역 전달과정에 몇가지 로직이 필요하다면 응용서비스를 두고 로직을 구현하면 된다.
	* 5장에서 다룬 동적인스턴스와 하이버네이트의 @Subselect를 이용해서 조회모듈을 구현할 수도 있다.
* 조회모델의 경우 다른 DB를 사용할 수도 있다. 
	* 조회성능이 좋은 메모리 기반 NoSQL
	* 두 저장소간의 데이터 동기화는 10장의 이벤트를 활용해서 처리
		* 명령모델의 상태 변경시 이벤트 발생 -> 이벤트를 조회모델에 전달해서 변경내역을 반영
	* 동기화 시점에 따라 구현방식이 달라질 수 있다.
		* 실시간 동기화 필요시 동기이벤트/글로벌 트랜잭션 사용 - 전반적인 성능 감소를 감수한다.
		* 특정시간 안에만 동기화 해도 된다면 비동기로 데이터를 전송해도 된다.
### 11.2.1 웹과 CQRS
* 일반적인 웹서비스는 상태 변경보다 상태 조회요청이 많다.
	* 조회성능을 높이기 위해 다양한 기법을 사용한다
		* 조회화면에 보여줄 데이터를 빠르게 읽어올 수 있도록 쿼리 최적화
		* 조회 화면에 맞는 모양으로 변환한 데이터를 메모리에 캐싱
		* 조회전용 저장소 사용
		
		* > 결과적으로 CQRS를 적용하는 효과를 만든다.
	* 조회속도를 높이기 위해 별도처리를 하고있다면 명시적으로 명령/조회 모델을 구분하자
		* 명령 모델이 복잡해지는 것을 막고
		* 조회기능에 특화된 구현기법을 보다 쉽게 적용할 수 있다.
		
### 11.2.2 CQRS 장단점
* 장점
	* 명령모델 구현시 도메인 자체에 집중할 수 있다.
		* 복잡한 도메인은 상태변경로직도 복잡하다
			* CQ구분시 조회성능을 위한 코드가 제거되어 도메인 로직 구현에 집중할 수 있고
			* 조회로직이 사라져 복잡도도 낮아진다.
	* 조회 성능 향상에 유리하다
		* 조회단위 캐시 기술 사용
		* 조회 특화 쿼리 사용
		* 전용저장소 사용하여 처리량 상승
		* 조회 성능을 위한 코드가 명령모델에 영향을 주지 않는다.
* 단점
	* 구현 코드량이 더 많다.
		* 단일 보델의 복잡도 증가와 조회전용 모델생성시의 구현비용을 비교해야 한다.
		* 도메인이 복잡하거나 대규모 트래픽이 발생하는 경우 조회 전용모델을 만드는 것이 유지보수에 유리하다.
	* 더 많은 구현 기술 필요
		* 각 모델 별 구현기술
		* 다른 저장소 사용
		* 데이터 동기화를 위한 메시징 시스템

* 장단점을 잘 고려해서 도입여부를 결정해야 한다.
